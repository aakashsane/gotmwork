#!/bin/bash
# Setup and run GOTM for CORE-II
#
# Qing Li, 20180307

#######################################################################
#                              Set path                               #
#######################################################################

workdir="${HOME}/models/gotm/gotmwork"
scratchdir="${HOME}/work/gotmrun"
tooldir="${workdir}/tools"
nmldir="${workdir}/namelist"
xmldir="${workdir}/data"
cmd_nmlchange="${tooldir}/nmlchange"
cmd_case_preproc="${tooldir}/case_preproc"
cmd_nc2dat_core2ww3_usp="${tooldir}/nc2dat_core2ww3_usp"
cmd_plotpfl="${tooldir}/plotpfl"
cmd_plotts="${tooldir}/plotts"
nc2dat_method="nc2dat_latlon"

#######################################################################
#                           Set parameters                            #
#######################################################################

datadir="/Volumes/Qing_Work/data/COREII_IAF"
uspdir="/Volumes/Qing_Work/data/WAVEWATCH_COREII"
lat=25
lon=180
maxdepth=500
title="COREII_LAT${lat}_LON${lon}"
outname="${title}"
# start and end date
datestart="20090325"
dateend="20090411"
uspdata="ww3.${datestart:0:4}_usp.nc"

turbmethod="KPP-CVMix"
# turbmethod="KPP-Original"
casename="${title}_${turbmethod}_${datestart}-${dateend}"

#######################################################################
#                        Preprocess input data                        #
#######################################################################
# create run dir
rundir="${scratchdir}/${casename}"
mkdir -p ${rundir}

cd ${rundir}
cp ${nmldir}/*.nml ./
# read data.xml
xmlfile="COREII.xml"
cp ${xmldir}/${xmlfile} ./
sed -i.bk "s#_TAG_NAME#\"${title}\"#g" ./${xmlfile}
sed -i.bk "s#_TAG_LAT#\"${lat}\"#g" ./${xmlfile}
sed -i.bk "s#_TAG_LON#\"${lon}\"#g" ./${xmlfile}
sed -i.bk "s#_TAG_MAXDEPTH#\"${maxdepth}\"#g" ./${xmlfile}
${cmd_case_preproc} -xml ${xmlfile} -root ${workdir} -data ${datadir} \
    -ds ${datestart} -de ${dateend} -method ${nc2dat_method}

${cmd_nc2dat_core2ww3_usp} -i ${uspdir}/${uspdata} -o "usp_file.dat" \
    -lat ${lat} -lon ${lon} -ds ${datestart} -de ${dateend}

${cmd_nmlchange} -f airsea.nml -e calc_fluxes -v .true.
${cmd_nmlchange} -f airsea.nml -e fluxes_method -v 2
${cmd_nmlchange} -f airsea.nml -e back_radiation_method -v 1

${cmd_nmlchange} -f obs.nml -e ustokes_method -v 3
${cmd_nmlchange} -f obs.nml -e nfreq -v 3
${cmd_nmlchange} -f obs.nml -e ustokes_file -v "usp_file.dat"

${cmd_nmlchange} -f gotmrun.nml -e title -v ${title}
${cmd_nmlchange} -f gotmrun.nml -e out_fn -v ${outname}
${cmd_nmlchange} -f gotmturb.nml -e turb_method -v 99

# turn on CVMix
${cmd_nmlchange} -f kpp.nml -e lcvmix -v .true.

#######################################################################
#                              Run GOTM                               #
#######################################################################
gotm 2> log.${outname}


#######################################################################
#                           Postprocessing                            #
#######################################################################

pp_vars="temp temp_obs salt salt_obs"
pp_date_start=${datestart}
pp_date_end=${dateend}
for pp_var in ${pp_vars}; do
    ${cmd_plotpfl} -f ${outname}.nc -v ${pp_var} -o "${pp_var}_${pp_date_start}-${pp_date_end}.pdf" -ds ${pp_date_start} -de ${pp_date_end} -ptype contourf
    ${cmd_plotts} -f ${outname}.nc -v tx ty heat I_0 -o "gotm_ts_surface_${pp_date_start}-${pp_date_end}.pdf" -ds ${pp_date_start} -de ${pp_date_end}
done
